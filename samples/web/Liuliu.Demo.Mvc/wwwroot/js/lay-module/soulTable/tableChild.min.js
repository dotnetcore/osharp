/**
 *
 * @name:  子表格扩展
 * @author: yelog
 * @link: https://github.com/yelog/layui-soul-table
 * @license: MIT
 * @version: v1.5.16
 */
layui.define(["table","element","form","laytpl"],function(n){var t=layui.jquery,i=layui.table,f=layui.laytpl,r={},u="soul-table-hover",e={render:function(n){var r=this,o=t(n.elem),h=o.next().children(".layui-table-box"),a=n.id,v=h.children(".layui-table-header").children("table"),c=h.children(".layui-table-fixed").children(".layui-table-body").children("table"),y=h.children(".layui-table-body").children("table"),e=t.merge(h.children(".layui-table-body").children("table"),c),l=r.getCompleteCols(n.cols),s=[],p=typeof n.soulSort=="undefined"||n.soulSort,u;for(r.fixHoverStyle(n),u=0;u<l.length;u++)l[u].children&&l[u].children.length>0&&s.push(u);if(typeof o.attr("lay-filter")=="undefined"&&o.attr("lay-filter",a),o.parents(".childTr").length===0){if(typeof n.rowEvent=="function")i.on("row("+o.attr("lay-filter")+")",function(i){var r=t(this).data("index");i.tr=e.children("tbody").children('tr[data-index="'+r+'"]');n.rowEvent(i)});if(typeof n.rowDoubleEvent=="function")i.on("rowDouble("+o.attr("lay-filter")+")",function(i){var r=t(this).data("index");i.tr=e.children("tbody").children('tr[data-index="'+r+'"]');n.rowDoubleEvent(i)})}if(s.length>0)for(u=0;u<s.length;u++)(function(){var h=l[s[u]],b=s[u],w=h.icon||["layui-icon layui-icon-right","layui-icon layui-icon-down"];if(p&&!(n.url&&n.page))i.on("sort("+o.attr("lay-filter")+")",function(){r.render(n)});h.isChild&&typeof h.isChild=="function"?e.find("tr").find('td[data-key$="'+h.key+'"]>div').each(function(n){h.isChild(layui.table.cache[a][n])&&(h.field?t(this).prepend('<i style="cursor: pointer" class="childTable '+w[0]+'"><\/i>'):t(this).html('<i style="cursor: pointer" class="childTable '+w[0]+'"><\/i>'))}):h.field?e.find("tr").find('td[data-key$="'+h.key+'"]>div').prepend('<i style="cursor: pointer" class="childTable '+w[0]+'"><\/i>'):e.find("tr").find('td[data-key$="'+h.key+'"]>div').html('<i style="cursor: pointer" class="childTable '+w[0]+'"><\/i>');e.children("tbody").children("tr").each(function(){t(this).children("td:eq("+b+")").find(".childTable").on("click",function(u){var tt,k,ft;layui.stope(u);var l=t(this).parents("tr:eq(0)").data("index"),p=n.id,rt=t(this).parents("td:eq(0)").data("key"),o=y.children("tbody").children("tr[data-index="+l+"]").children('td[data-key="'+rt+'"]').find(".childTable:eq(0)"),ut=c.find("tr[data-index="+l+"]").children('td[data-key="'+rt+'"]').find(".childTable:eq(0)"),s=i.cache[p][l],a=h.children,b=!1,d="",g=e.children("tbody").children('tr[data-index="'+l+'"]'),nt={data:s,tr:g,del:function(){i.cache[p][l]=[];r.destroyChildren(l,n,w);g.remove();i.resize(p)},update:function(n){n=n||{};layui.each(n,function(n,r){if(n in s){var u,e=g.children('td[data-field="'+n+'"]');s[n]=r;i.eachCols(p,function(t,i){i.field==n&&i.templet&&(u=i.templet)});e.children(".layui-table-cell").html(function(){return u?function(){return typeof u=="function"?u(s):f(t(u).html()||r).render(s)}():r}());e.data("content",r)}})},close:function(){r.destroyChildren(l,n,w);i.resize(p)}};if(o.hasClass(w[1])){if(typeof h.childClose=="function"&&h.childClose(nt)===!1)return}else if(typeof h.childOpen=="function"&&h.childOpen(nt)===!1)return;if(typeof a=="function"&&(a=a(s)),typeof a=="string"&&(b=!0,d=r.parseTempData(h,h.field?s[h.field]:null,s)),h.show===2)h.layerOption?typeof h.layerOption.title=="function"?h.layerOption.title=h.layerOption.title(s):null:null,layer.open(t.extend({type:1,title:"子表",maxmin:!0,content:r.getTables(this,s,h,n,a,b,d),area:"1000px",offset:"100px",cancel:function(){typeof h.childClose=="function"&&h.childClose(nt)===!1}},h.layerOption||{})),b||r.renderTable(this,s,h,n,a,w);else if(!o.hasClass(w[1])&&h.collapse&&e.children("tbody").children("tr").children("td").find(".childTable").each(function(){t(this).hasClass(w[1])&&r.destroyChildren(t(this).parents("tr:eq(0)").data("index"),n,w)}),o.hasClass(w[1])||o.parents("tr:eq(0)").children("td").find(".childTable").each(function(){t(this).hasClass(w[1])&&(t(this).removeClass(w[1]).addClass(w[0]),r.destroyChildren(t(this).parents("tr:eq(0)").data("index"),n,w))}),o.hasClass(w[1])?(o.removeClass(w[1]).addClass(w[0]),ut.removeClass(w[1]).addClass(w[0])):(o.removeClass(w[0]).addClass(w[1]),ut.removeClass(w[0]).addClass(w[1])),tt=o.parents("td:eq(0)").attr("rowspan"),o.hasClass(w[1])){if(k=[],k.push('<tr data-tpl="'+b+'" class="noHover childTr"><td colspan="'+v.find("th:visible").length+'"  style="cursor: inherit; padding: 0;">'),k.push(r.getTables(this,s,h,n,a,b,d)),k.push("<\/td><\/tr>"),tt?(ft=parseInt(o.parents("tr:eq(0)").data("index"))+parseInt(tt)-1,o.parents("table:eq(0)").children().children("[data-index='"+ft+"']").after(k.join(""))):o.parents("tr:eq(0)").after(k.join("")),layui.element.init("tab"),!b){r.renderTable(this,s,h,n,a,w);o.parents("tr:eq(0)").next().children("td").children(".layui-tab").children(".layui-tab-content").on("click",function(n){t(n.target.parentElement).hasClass("layui-tab-title")||n.stopPropagation()}).off("dblclick").on("dblclick",function(n){n.stopPropagation()}).on("mouseenter","td",function(n){n.stopPropagation()}).on("change",function(n){layui.stope(n)})}if(c.length>0){var it=o.parents("tr:eq(0)").next(),ot=it.children("td").height(),et='<div class="soul-table-child-patch" style="height: '+ot+'px"><\/div>';it.children("td").children(".layui-tab-card").css({position:"absolute",top:0,width:"100%",background:"white","z-index":200});it.children("td").append(et);c.find('tr[data-index="'+l+'"]').each(function(){t(this).after('<tr><td style="padding: 0;" colspan="'+t(this).children("[data-key]").length+'">'+et+"<\/td><\/tr>")});i.resize(p)}h.show===3&&(o.parents("tr:eq(0)").next().find(".layui-table-view").css({margin:0,"border-width":0}),o.parents("tr:eq(0)").next().find(".layui-table-header").css("display","none"))}else r.destroyChildren(l,n,w),i.resize(p)})});h.spread&&h.show!==2&&e.children("tbody").children("tr").children("td").find(".childTable").trigger("click")})()},getTables:function(n,i,r,u,f,e,o){var s=[],v=t(u.elem),b=v.next().children(".layui-table-box"),k=u.id,y=k+t(n).parents("tr:eq(0)").data("index"),p=b.children(".layui-table-header").children("table"),c=v.next().children(".layui-table-box").children(".layui-table-body"),d=c.children("table"),w=0,h,l,a;if(e?s.push('<div style="margin: 0;border: 0;box-shadow: none;'):s.push('<div class="layui-tab layui-tab-card" lay-filter="table-child-tab-'+y+'" style="margin: 0;border: 0;box-shadow: none;'),r.show===2?s.push("max-width: "+(d.width()-2)+'px">'):r.show===3?s.push('">'):r.childWidth==="full"?s.push('">'):(c.prop("scrollHeight")+(f.length>0?f[0].height:0)>c.height()&&(w=this.getScrollWidth()),l=c.width()-1-w,s.push("max-width: "+(l>p.width()?p.width():l)+'px">')),e)s.push(o);else{if(r.show!==3&&(typeof r.childTitle=="undefined"||r.childTitle)){for(s.push('<ul class="layui-tab-title">'),h=0;h<f.length;h++)s.push('<li class="'+(h===0?"layui-this":"")+'">'+(typeof f[h].title=="function"?f[h].title(i):f[h].title)+"<\/li>");s.push("<\/ul>")}for(r.show===3?s.push('<div class="layui-tab-content" style="padding: 0">'):s.push('<div class="layui-tab-content" style="padding: 0 10px">'),h=0;h<f.length;h++)a=y+h,s.push('<div class="layui-tab-item layui-show"><form action="" class="layui-form" ><table id="'+a+'" lay-filter="'+a+'"><\/table><\/form><\/div>');s.push("<\/div>")}return s.push("<\/div>"),s.join("")},renderTable:function(n,u,e,o,s,h){function y(n,r,u,e,o,s,h,c){var l=n.deepClone(h[s]),k,v=o.id,y=t(r).parents("tr:eq(0)").data("index"),a=v+y+s,g=t(o.elem),d=g.next().children(".layui-table-box"),nt=t.merge(d.children(".layui-table-body").children("table"),d.children(".layui-table-fixed").children(".layui-table-body").children("table")),b=nt.children("tbody").children('tr[data-index="'+y+'"]'),w=i.cache[v][y],p={data:w,tr:b,del:function(){i.cache[v][y]=[];n.destroyChildren(y,o,c);b.remove();i.resize(v)},update:function(n){n=n||{};layui.each(n,function(n,r){if(n in w){var u,e=b.children('td[data-field="'+n+'"]');w[n]=r;i.eachCols(v,function(t,i){i.field==n&&i.templet&&(u=i.templet)});e.children(".layui-table-cell").html(function(){return u?function(){return typeof u=="function"?u(w):f(t(u).html()||r).render(w)}():r}());e.data("content",r)}})},close:function(){n.destroyChildren(y,o,c);i.resize(v)}};if(l.id=a,l.elem="#"+a,typeof l.where=="function"&&(l.where=l.where(u)),typeof l.data=="function"&&(l.data=l.data(u)),typeof l.url=="function"&&(l.url=l.url(u)),k=i.render(l),e.lazy||s===0||t("#"+a).parents(".layui-tab-item:eq(0)").removeClass("layui-show"),typeof l.checkboxEvent=="function")i.on("checkbox("+a+")",function(n){l.checkboxEvent(n,p)});if(typeof l.editEvent=="function")i.on("edit("+a+")",function(n){n.oldValue=t(this).prev().text();l.editEvent(n,p)});if(typeof l.toolEvent=="function")i.on("tool("+a+")",function(n){l.toolEvent(n,p)});if(typeof l.toolbarEvent=="function")i.on("toolbar("+a+")",function(n){l.toolbarEvent(n,p)});if(typeof l.rowEvent=="function")i.on("row("+a+")",function(n){l.rowEvent(n,p)});if(typeof l.rowDoubleEvent=="function")i.on("rowDouble("+a+")",function(n){l.rowDoubleEvent(n,p)});return k}var a=[],v=this,p=o.id,l=p+t(n).parents("tr:eq(0)").data("index"),c;if(e.lazy)a.push(y(v,n,u,e,o,0,s,h));else for(c=0;c<s.length;c++)a.push(y(v,n,u,e,o,c,s,h));r[l]=a;layui.element.on("tab(table-child-tab-"+l+")",function(f){var h,a,w;if(e.lazy){for(h=!1,c=0;c<r[l].length;c++)if(r[l][c].config.id===l+f.index){h=!0;break}h||r[l].push(y(v,n,u,e,o,f.index,s))}a=t(n).parents("tr:eq(0)").data("index");w=t(f.elem).height();t(n).parents(".layui-table-box:eq(0)").children(".layui-table-body").children("table").children("tbody").children("tr[data-index="+a+"]").next().children().children(".soul-table-child-patch").css("height",w);t(n).parents(".layui-table-box:eq(0)").children(".layui-table-fixed").children(".layui-table-body").children("table").children("tbody").children("tr[data-index="+a+"]").next().children().children(".soul-table-child-patch").css("height",w);i.resize(p)})},destroyChildren:function(n,i,u){var f=i.id,c=t(i.elem),s=c.next().children(".layui-table-box"),l=s.children(".layui-table-fixed").children(".layui-table-body").children("table"),a=t.merge(s.children(".layui-table-body").children("table"),l),o=a.children("tbody").children('tr[data-index="'+n+'"]'),v=o.next().data("tpl"),h,e;if(o.find(".childTable").removeClass(u[1]).addClass(u[0]),o.next().remove(),v==="false"&&(h=r[f+n],layui.tableFilter&&layui.tableFilter.destroy(h),layui.soulTable))for(e=0;e<r[f+n].length;e++)layui.soulTable.clearOriginCols(r[f+n][e].config.id);delete r[f+n]},cloneJSON:function(n){var t={PREFIX:"[[JSON_FUN_PREFIX_",SUFFIX:"_JSON_FUN_SUFFIX]]"},i=JSON.stringify(n,function(n,i){return typeof i=="function"?t.PREFIX+i.toString()+t.SUFFIX:i});return JSON.parse(i,function(n,i){return typeof i=="string"&&i.indexOf(t.SUFFIX)>0&&i.indexOf(t.PREFIX)===0?eval("("+i.replace(t.PREFIX,"").replace(t.SUFFIX,"")+")"):i})||{}},fixHoverStyle:function(n){var i=t(n.elem),r=i.next().children(".layui-table-box").children(".layui-table-body").children("table"),f=i.next().children(".layui-table-box").children(".layui-table-fixed").children(".layui-table-body").children("table"),e=i.next().find("style")[0],o=e.sheet||e.styleSheet||{};this.addCSSRule(o,".layui-table-hover","background-color: inherit");this.addCSSRule(o,".layui-table-hover.soul-table-hover","background-color: #F2F2F2");t.merge(f.children("tbody").children("tr"),r.children("tbody").children("tr")).on("mouseenter",function(){var i=t(this),n=t(this).data("index");i.data("off")||(f.children("tbody").children("tr[data-index="+n+"]").addClass(u),r.children("tbody").children("tr[data-index="+n+"]").addClass(u))}).on("mouseleave",function(){var i=t(this),n=t(this).data("index");i.data("off")||(f.children("tbody").children("tr[data-index="+n+"]").removeClass(u),r.children("tbody").children("tr[data-index="+n+"]").removeClass(u))})},addCSSRule:function(n,t,i,r){"insertRule"in n?n.insertRule(t+"{"+i+"}",r):"addRule"in n&&n.addRule(t,i,r)},deepClone:function(n){var i=Array.isArray(n)?[]:{},t;if(n&&typeof n=="object")for(t in n)n.hasOwnProperty(t)&&(i[t]=n&&typeof n[t]=="object"?this.deepClone(n[t]):n[t]);return i},getCompleteCols:function(n){for(var t=this.deepClone(n),i,u,f,r=0;r<t.length;r++)for(i=0;i<t[r].length;i++)if(!t[r][i].exportHandled){if(t[r][i].rowspan>1)for(f=this.deepClone(t[r][i]),f.exportHandled=!0,u=r+1;u<t.length;)t[u].splice(i,0,f),u++;if(t[r][i].colspan>1){for(f=this.deepClone(t[r][i]),f.exportHandled=!0,u=1;u<t[r][i].colspan;u++)t[r].splice(i,0,f);i=i+parseInt(t[r][i].colspan)-1}}return t[t.length-1]},getScrollWidth:function(n){var t=0;return n?t=n.offsetWidth-n.clientWidth:(n=document.createElement("div"),n.style.width="100px",n.style.height="100px",n.style.overflowY="scroll",document.body.appendChild(n),t=n.offsetWidth-n.clientWidth,document.body.removeChild(n)),t},parseTempData:function(n,i,r,u){var e=n.children?function(){return typeof n.children=="function"?n.children(r):f(t(n.children).html()||String(i)).render(r)}():i;return u?t("<div>"+e+"<\/div>").text():e}};n("tableChild",e)});